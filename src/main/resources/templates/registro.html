<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>Nuevo Producto - La Choza</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<style>
		.card-header {
			background-color: #198754;
		}

		/* Verde para combinar con La Choza */
	</style>
</head>

<body class="bg-light">
	<div class="container mt-5">
		<div class="card shadow mx-auto" style="max-width: 550px;">
			<div class="card-header text-white">
				<h4 class="mb-0">Añadir al Menú</h4>
			</div>
			<div class="card-body">
				<form id="form-nuevo-producto">
					<div class="mb-3">
						<label class="form-label">Nombre del Plato</label>
						<input type="text" id="nombre" class="form-control" placeholder="Ej. Chivo al Hueco" required>
					</div>

					<div class="row">
						<div class="col-md-6 mb-3">
							<label class="form-label">Precio</label>
							<input type="number" step="0.01" id="precio" class="form-control" placeholder="0.00"
								required>
						</div>
						<div class="col-md-6 mb-3">
							<label class="form-label">Stock Inicial</label>
							<input type="number" id="stockActual" class="form-control" value="10" required>
						</div>
					</div>

					<div class="mb-3">
						<label class="form-label">Categoría</label>
						<select id="categoriaId" class="form-select" required>
							<option value="">Cargando categorías...</option>
						</select>
					</div>

					<div class="mb-3">
						<label class="form-label">Descripción</label>
						<textarea id="descripcion" class="form-control" rows="2"
							placeholder="Detalles del plato..."></textarea>
					</div>

					<div class="d-grid gap-2">
						<button type="submit" class="btn btn-success">Guardar Producto</button>
						<a th:href="@{/producto}" class="btn btn-outline-secondary">Volver al Menú</a>
					</div>
				</form>
			</div>
		</div>
	</div>

	<script>
		// 1. Cargar categorías al iniciar la página
		document.addEventListener("DOMContentLoaded", () => {
			fetchCategorias();
		});

		async function fetchCategorias() {
			try {
				const response = await fetch("/api/categorias");
				if (!response.ok) throw new Error("Error al obtener categorías");

				const categorias = await response.json();
				const select = document.getElementById("categoriaId");
				select.innerHTML = '<option value="">Seleccione una categoría</option>';

				categorias.forEach(cat => {
					const option = document.createElement("option");
					option.value = cat.id;
					option.textContent = cat.nombre;
					select.appendChild(option);
				});
			} catch (error) {
				console.error("Error:", error);
				document.getElementById("categoriaId").innerHTML = '<option value="">Error al cargar</option>';
			}
		}

		// 2. Manejar el envío del formulario
		document.getElementById('form-nuevo-producto').addEventListener('submit', async (e) => {
			e.preventDefault();

			const datos = {
				nombre: document.getElementById('nombre').value,
				precio: parseFloat(document.getElementById('precio').value),
				stockActual: parseInt(document.getElementById('stockActual').value),
				descripcion: document.getElementById('descripcion').value,
				disponible: true,
				categoria: {
					id: parseInt(document.getElementById('categoriaId').value)
				}
			};

			try {
				const response = await fetch('/api/productos', {
					method: 'POST',
					headers: {'Content-Type': 'application/json'},
					body: JSON.stringify(datos)
				});

				if (response.ok) {
					alert("✅ Producto registrado con éxito en La Choza");
					window.location.href = "/producto";
				} else {
					const errorMsg = await response.text();
					alert("❌ Error: " + errorMsg);
				}
			} catch (error) {
				alert("❌ No se pudo conectar con el servidor.");
			}
		});
	</script>
</body>

</html>